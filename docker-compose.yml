version: '3.8'

# Shared configuration for all environments
x-base-config: &base-config
  # Port 11235 is exposed to host for network access (see ports mapping in crawl4ai service)
  # Do NOT configure a public domain in Coolify UI - keep this app internal-only
  # Note: env_file removed - Coolify manages environment variables directly
  # Set LLM_PROVIDER and other env vars in Coolify UI instead of using .llm.env
  volumes:
    - /dev/shm:/dev/shm  # Chromium performance
  deploy:
    resources:
      limits:
        memory: 4G
      reservations:
        memory: 1G
  restart: unless-stopped
  healthcheck:
    test: ["CMD", "curl", "-f", "http://localhost:11235/health"]
    interval: 30s
    timeout: 10s
    retries: 3
    start_period: 40s
  user: "appuser"

services:
  redis:
    image: redis:7-alpine
    container_name: crawl4ai-redis
    # No port mapping needed - Redis is only accessed internally via Docker network
    volumes:
      - redis_data:/data
    command: redis-server --appendonly yes
    restart: unless-stopped
    healthcheck:
      test: ["CMD", "redis-cli", "ping"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s
    networks:
      - crawl4ai-network

  crawl4ai:
    # OPTION 1: Use pre-built image from Docker Hub (FASTEST - Recommended for production)
    # This pulls the image instead of building, reducing deployment time from 6-7 min to 30-60 sec
    # To use: Set IMAGE environment variable or use default (unclecode/crawl4ai:latest)
    image: ${IMAGE:-unclecode/crawl4ai:${TAG:-latest}}
    
    # OPTION 2: Build from source (slower, but allows customization)
    # To use: Uncomment the build section below and comment out or remove the image line above
    # Note: If both image and build are specified, Docker Compose will build and tag with the image name
    # build:
    #   context: .
    #   dockerfile: Dockerfile
    #   args:
    #     INSTALL_TYPE: ${INSTALL_TYPE:-default}
    #     ENABLE_GPU: ${ENABLE_GPU:-false}
    
    # Inherit shared config
    <<: *base-config
    
    # Expose port to host for network access (without public domain)
    ports:
      - "11235:11235"
    
    # Use external Redis service - explicit container name to avoid DNS collision
    # on the shared 'coolify' network where multiple Redis containers exist
    environment:
      - REDIS_URI=redis://crawl4ai-redis:6379/0
    depends_on:
      redis:
        condition: service_healthy
    networks:
      - crawl4ai-network
      - coolify  # Connect to Coolify network for internal access by other Coolify apps
    
    # No Traefik labels - app is internal-only, accessible via host port or Docker network
    # Access from other machines: http://<server-ip>:11235
    # Other Coolify apps can access this service using: http://crawl4ai:11235
    # Ensure no public domain is configured in Coolify UI for this application

networks:
  crawl4ai-network:
    driver: bridge
  coolify:
    external: true  # Use existing Coolify network for Ollama access

volumes:
  redis_data:
    driver: local